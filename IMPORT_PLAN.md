# 엑셀 업로드 기능 개발 계획

## 개요

거래내역 또는 카테고리 정보를 엑셀 파일로 업로드하여 일괄 추가/덮어쓰기하는 기능을 개발합니다.

---

## 1. 기능 범위

### 1.1 지원 대상

- ✅ **거래내역 업로드** (우선 개발)
- ✅ **카테고리 업로드** (추후 개발)

### 1.2 지원 파일 형식

- **Excel** (`.xlsx`, `.xls`)

---

## 2. 거래내역 업로드 상세

### 2.1 엑셀 컬럼 구조

**필수 컬럼:**

- `타입` 또는 `type` (수입/지출) - `income` 또는 `expense`
- `금액` 또는 `amount` (숫자)
- `날짜` 또는 `date` (YYYY-MM-DD, YYYY/MM/DD, DD/MM/YYYY 등)
- `대분류` 또는 `category1` (카테고리 1단계)
- `소분류` 또는 `category2` (카테고리 2단계)
- `내역` 또는 `description` (거래 설명)

**선택 컬럼:**

- `결제수단` 또는 `paymentMethod1` (지출일 때만, 카테고리 1단계)
- `세부결제수단` 또는 `paymentMethod2` (지출일 때만, 카테고리 2단계)
- `메모` 또는 `memo`

**컬럼명 처리:**

- 한글/영문 컬럼명 모두 지원
- **데이터 업로드 시에는 영문 컬럼명만 사용하여 판단**
- 컬럼명 매핑: 한글 → 영문 변환 테이블 사용

**컬럼명 예시:**

```
타입 | 금액 | 날짜 | 대분류 | 소분류 | 결제수단 | 세부결제수단 | 내역 | 메모
```

또는 영어:

```
type | amount | date | category1 | category2 | paymentMethod1 | paymentMethod2 | description | memo
```

### 2.2 데이터 검증 규칙

1. **필수 필드 체크**
   - 타입, 금액, 날짜, 대분류, 소분류, 내역 필수

2. **타입 검증**
   - `타입`: `income` 또는 `expense` (대소문자 무시, 한글: "수입"/"지출"도 지원)
   - `금액`: 숫자 (양수)
   - `날짜`: 유효한 날짜 형식 (여러 형식 지원)

3. **날짜 형식 변환**
   - 입력: `YYYY-MM-DD`, `YYYY/MM/DD`, `DD/MM/YYYY`, `MM/DD/YYYY` 등 지원
   - 저장: `YYYY-MM-DD` 형식으로 통일

4. **카테고리 검증**
   - 대분류/소분류가 현재 가계부의 카테고리 목록에 존재하는지 확인
   - 존재하지 않으면 에러 표시 (자동 생성 옵션은 추후)

5. **결제수단 검증** (지출일 때만)
   - 결제수단이 현재 가계부의 결제수단 목록에 존재하는지 확인

6. **중복 체크** (선택)
   - 동일한 날짜, 금액, 내역이 이미 존재하는지 확인 (옵션)

### 2.3 처리 흐름

```
1. 파일 선택/드래그 앤 드롭
2. 파일 파싱 (Excel)
3. 컬럼명 매핑 (한글 → 영문)
4. 데이터 검증
   - 각 행 검증
   - 날짜 형식 변환 (YYYY-MM-DD로 통일)
   - 에러가 있는 행은 별도 표시
5. 미리보기 (검증된 데이터)
   - 성공: N개
   - 실패: M개 (에러 메시지 표시)
6. 사용자 확인
7. 일괄 추가
   - 진행 상황 표시 (프로그레스 바)
   - 암호화 처리 (거래내역)
   - Firestore에 저장 (배치 처리)
8. 결과 표시
   - 성공: N개 추가됨
   - 실패: M개 실패 (상세 에러)
```

---

## 3. 카테고리 업로드 상세

### 3.1 엑셀 컬럼 구조

**카테고리 타입별 시트 또는 컬럼:**

- `타입` 또는 `type` (income/expense/payment/asset)
- `대분류` 또는 `category1`
- `소분류` 또는 `category2` (여러 개 가능, 쉼표로 구분)

**예시:**

```
타입 | 대분류 | 소분류
expense | 식비 | 외식,배달,장보기,카페/디저트
expense | 교통 | 대중교통,택시,주유
```

### 3.2 덮어쓰기 방식

**현재 결정: 덮어쓰기 방식**

- 업로드한 카테고리로 **완전히 교체**
- 기존 카테고리는 삭제됨

**주의사항:**

- 기존 거래내역에서 사용 중인 카테고리가 삭제되면:
  - 거래내역의 `category1`, `category2`는 그대로 유지 (문자열로 저장되어 있음)
  - 통계에서는 정상 작동 (거래내역의 category1을 직접 사용)
  - **하지만 새 거래 추가 시 해당 카테고리를 선택할 수 없음**

**해결 방안:**

1. **경고 표시** (추천)
   - 업로드 전에 "기존 거래내역에서 사용 중인 카테고리가 삭제됩니다" 경고
   - 사용 중인 카테고리 목록 표시
   - 사용자 확인 후 진행

2. **병합 방식** (선택)
   - 기존 카테고리 유지 + 새 카테고리 추가
   - 중복 제거

3. **used 플래그** (복잡함, 추후 고려)
   - 카테고리에 `used` 필드 추가
   - 사용 중인 카테고리는 `used: true`로 표시
   - 덮어쓰기 시 `used: false`인 카테고리만 삭제

**현재 구현: 덮어쓰기 + 경고 표시**

### 3.3 처리 흐름

```
1. 파일 선택/드래그 앤 드롭
2. 파일 파싱 (Excel)
3. 컬럼명 매핑 (한글 → 영문)
4. 데이터 검증
   - 카테고리 타입 확인
   - 대분류/소분류 구조 검증
5. 기존 거래내역에서 사용 중인 카테고리 확인
6. 경고 표시 (사용 중인 카테고리 목록)
7. 사용자 확인
8. 덮어쓰기
   - 진행 상황 표시
   - Firestore에 저장
9. 결과 표시
```

---

## 4. 기술 스택

### 4.1 필요한 라이브러리

```json
{
  "xlsx": "^0.18.5" // Excel 파일 파싱
}
```

### 4.2 파일 구조

```
src/
├── components/
│   └── import/
│       ├── ImportTransactionModal.tsx  # 거래내역 업로드 모달
│       ├── ImportCategoryModal.tsx     # 카테고리 업로드 모달
│       ├── ImportPreview.tsx           # 업로드 전 미리보기
│       └── ImportProgress.tsx         # 업로드 진행 상황
├── lib/
│   └── import/
│       ├── excelParser.ts              # Excel 파싱
│       ├── columnMapper.ts             # 컬럼명 매핑 (한글 → 영문)
│       ├── dateParser.ts               # 날짜 형식 파싱
│       ├── transactionValidator.ts    # 거래내역 검증
│       ├── transactionImporter.ts     # 거래내역 일괄 추가
│       ├── categoryValidator.ts        # 카테고리 검증
│       └── categoryImporter.ts         # 카테고리 덮어쓰기
└── hooks/
    └── useImport.ts                   # 업로드 로직 훅
```

---

## 5. UI/UX 설계

### 5.1 진입점

**거래내역 페이지:**

- "거래 추가" 버튼 옆에 "일괄 업로드" 버튼 추가
- 또는 헤더에 "데이터 업로드" 메뉴

**카테고리 설정 페이지:**

- "카테고리 업로드" 버튼 추가

### 5.2 업로드 모달/페이지

**PC: 모달**

- 파일 선택 영역 (드래그 앤 드롭 지원)
- 파일 형식 안내
- 템플릿 다운로드 버튼

**모바일: 전체 페이지**

- 파일 선택 화면
- 업로드 진행 화면

### 5.3 미리보기 화면

- **성공한 데이터**: 테이블 형태로 표시
- **실패한 데이터**: 에러 메시지와 함께 표시
- **수정 가능**: 실패한 데이터를 수정하여 재검증

### 5.4 진행 상황

- 프로그레스 바
- "N개 중 M개 처리 중..."
- 취소 버튼 (선택)

---

## 6. 데이터 처리

### 6.1 파싱

**Excel:**

```typescript
// xlsx 사용
const workbook = XLSX.read(file, { type: 'array' })
const sheet = workbook.Sheets[workbook.SheetNames[0]]
const data = XLSX.utils.sheet_to_json(sheet)
```

### 6.2 컬럼명 매핑

```typescript
const COLUMN_MAP = {
  // 한글 → 영문
  타입: 'type',
  금액: 'amount',
  날짜: 'date',
  대분류: 'category1',
  소분류: 'category2',
  결제수단: 'paymentMethod1',
  세부결제수단: 'paymentMethod2',
  내역: 'description',
  메모: 'memo',
}

function mapColumns(row: Record<string, any>): Record<string, any> {
  const mapped: Record<string, any> = {}
  Object.entries(row).forEach(([key, value]) => {
    const mappedKey = COLUMN_MAP[key] || key.toLowerCase()
    mapped[mappedKey] = value
  })
  return mapped
}
```

### 6.3 날짜 파싱

```typescript
function parseDate(dateStr: string): Date {
  // 여러 형식 지원
  // YYYY-MM-DD, YYYY/MM/DD, DD/MM/YYYY, MM/DD/YYYY 등
  // 최종적으로 YYYY-MM-DD 형식으로 변환
}
```

### 6.4 데이터 변환

```typescript
interface ImportRow {
  type: string
  amount: string | number
  date: string
  category1: string
  category2: string
  paymentMethod1?: string
  paymentMethod2?: string
  description: string
  memo?: string
}

// 변환 로직
function convertToTransaction(
  row: ImportRow,
  ledgerId: string
): Omit<Transaction, 'id' | 'createdAt' | 'createdBy' | 'updatedBy'> {
  return {
    ledgerId,
    type: normalizeType(row.type),
    amount: Number(row.amount),
    date: parseDate(row.date), // YYYY-MM-DD로 통일
    category1: row.category1.trim(),
    category2: row.category2.trim(),
    paymentMethod1: row.paymentMethod1?.trim(),
    paymentMethod2: row.paymentMethod2?.trim(),
    description: row.description.trim(),
    memo: row.memo?.trim(),
  }
}
```

### 6.5 일괄 추가

**배치 처리:**

- 100건 단위로 배치 처리
- Firestore batch write 사용 (최대 500건)
- 진행 상황 실시간 업데이트

### 6.6 암호화 처리

- 거래내역 추가 시 자동 암호화
- `transactionStore.addTransaction` 사용 (이미 암호화 처리됨)

---

## 7. 에러 처리

### 7.1 검증 에러

- **필수 필드 누락**: "N번째 행: '금액' 필드가 없습니다"
- **잘못된 형식**: "N번째 행: 날짜 형식이 올바르지 않습니다"
- **카테고리 없음**: "N번째 행: '식비 > 외식' 카테고리가 존재하지 않습니다"

### 7.2 저장 에러

- **Firestore 에러**: "N번째 행 저장 실패: 권한 없음"
- **네트워크 에러**: 재시도 옵션 제공

### 7.3 에러 리포트

- 실패한 행 목록 다운로드 (Excel)
- 수정 후 재업로드 가능

---

## 8. 성능 고려사항

### 8.1 대용량 파일 처리

- **청크 단위 처리**: 100건씩 나누어 처리
- **진행 상황 표시**: 사용자에게 피드백 제공

### 8.2 제한사항

- **최대 파일 크기**: 10MB
- **최대 행 수**: 10,000행 (선택)
- **동시 업로드**: 1개만 허용

---

## 9. 보안 고려사항

1. **파일 검증**
   - 파일 확장자 체크
   - MIME 타입 체크
   - 악성 파일 방지

2. **데이터 검증**
   - XSS 방지 (입력값 sanitization)
   - SQL Injection 방지 (Firestore 사용으로 자동 방지)

3. **권한 체크**
   - Viewer는 업로드 불가
   - `useLedgerPermission` 훅 사용

---

## 10. 개발 단계

### Phase 1: 거래내역 업로드 (우선)

1. ✅ 라이브러리 설치 (`xlsx`)
2. ✅ Excel 파서 구현
3. ✅ 컬럼명 매핑 (한글 → 영문)
4. ✅ 날짜 파서 (여러 형식 지원 → YYYY-MM-DD 통일)
5. ✅ 데이터 검증 로직
6. ✅ UI 컴포넌트 (모달/페이지)
7. ✅ 일괄 추가 로직 (배치 처리)
8. ✅ 에러 처리
9. ✅ 테스트

### Phase 2: 카테고리 업로드

1. ⏳ 카테고리 파서 구현
2. ⏳ 기존 거래내역에서 사용 중인 카테고리 확인
3. ⏳ 경고 UI 구현
4. ⏳ 덮어쓰기 로직
5. ⏳ 테스트

### Phase 3: 개선

1. ⏳ 템플릿 다운로드 기능
2. ⏳ 중복 체크 옵션
3. ⏳ 진행 상황 개선
4. ⏳ 에러 리포트 다운로드

---

## 11. 템플릿 파일

사용자가 쉽게 업로드할 수 있도록 템플릿 파일 제공:

**거래내역 템플릿 (Excel):**

- 컬럼: 타입, 금액, 날짜, 대분류, 소분류, 결제수단, 세부결제수단, 내역, 메모
- 샘플 데이터 2-3행 포함
- 컬럼 설명 포함

**카테고리 템플릿 (Excel):**

- 컬럼: 타입, 대분류, 소분류
- 샘플 데이터 포함

---

## 12. 카테고리 덮어쓰기 상세 분석

### 12.1 현재 구조

- 거래내역: `category1`, `category2`를 **문자열로 저장**
- 통계: 거래내역의 `category1`을 **직접 사용** (카테고리 목록과 비교하지 않음)
- 카테고리 선택 UI: `categories/{ledgerId}` 문서의 카테고리 목록 사용

### 12.2 덮어쓰기 시나리오

**시나리오: "식비 > 외식" 카테고리를 삭제하고 덮어쓰기**

1. **기존 거래내역**: `category1: "식비"`, `category2: "외식"` → **그대로 유지**
2. **통계**: "식비"로 정상 집계됨 (거래내역의 category1을 직접 사용)
3. **카테고리 선택 UI**: "식비 > 외식"이 사라져서 **새 거래 추가 시 선택 불가**
4. **문제점**: 기존 거래는 정상 작동하지만, 새 거래 추가 시 해당 카테고리를 사용할 수 없음

### 12.3 해결 방안

**방안 1: 덮어쓰기 + 경고 표시** (추천)

- 업로드 전에 사용 중인 카테고리 목록 표시
- "다음 카테고리가 기존 거래내역에서 사용 중입니다. 삭제하면 새 거래 추가 시 사용할 수 없습니다."
- 사용자 확인 후 진행

**방안 2: 병합 방식**

- 기존 카테고리 유지 + 새 카테고리 추가
- 중복 제거
- 사용자가 원하는 방식이 아님

**방안 3: used 플래그** (복잡함)

- 카테고리 구조 변경 필요
- `used: true/false` 필드 추가
- 덮어쓰기 시 `used: false`인 카테고리만 삭제
- 현재는 구현하지 않음 (추후 고려)

**현재 결정: 방안 1 (덮어쓰기 + 경고 표시)**

---

## 13. 진입점 결정

### 13.1 거래내역 업로드

**추천: 거래내역 페이지**

- "거래 추가" 버튼 옆에 "일괄 업로드" 버튼 추가
- 컨텍스트가 명확함
- 사용자가 거래내역을 관리하는 곳에서 바로 접근 가능

**대안: 설정 메뉴**

- "데이터 업로드" 메뉴 항목
- 덜 직관적일 수 있음

### 13.2 카테고리 업로드

**추천: 카테고리 설정 페이지**

- 카테고리 관리 페이지에 "카테고리 업로드" 버튼 추가
- 컨텍스트가 명확함

---

## 14. 테스트 시나리오

### 14.1 정상 케이스

- ✅ Excel 파일 업로드 (10건)
- ✅ 한글 컬럼명 파일
- ✅ 영문 컬럼명 파일
- ✅ 대용량 파일 (1000건)
- ✅ 선택 필드 없는 데이터
- ✅ 여러 날짜 형식 (YYYY-MM-DD, YYYY/MM/DD 등)

### 14.2 에러 케이스

- ✅ 필수 필드 누락
- ✅ 잘못된 날짜 형식
- ✅ 존재하지 않는 카테고리
- ✅ 잘못된 파일 형식
- ✅ 빈 파일
- ✅ 권한 없음 (Viewer)

### 14.3 엣지 케이스

- ✅ 특수문자 포함
- ✅ 매우 긴 텍스트
- ✅ 음수 금액 (지출)
- ✅ 미래 날짜

---

## 15. 예상 작업 시간

- **Phase 1 (거래내역 업로드)**: 4-6시간
- **Phase 2 (카테고리 업로드)**: 2-3시간
- **Phase 3 (개선)**: 2-3시간

**총 예상 시간**: 8-12시간

---

## 마지막 업데이트

- 날짜: 2024-11-27
- 버전: 2.0.0
- 상태: 개발 준비 완료
