# 데이터 내보내기 기능 개발 계획

## 개요

거래내역 및 자산 데이터를 CSV/Excel 형식으로 내보내는 기능을 개발합니다.

---

## 1. 기능 범위

### 1.1 지원 대상

- ✅ **거래내역 내보내기** (우선 개발)
- ✅ **자산 현황 내보내기** (추후 개발)
- ⏳ **카테고리 내보내기** (선택적)

### 1.2 지원 파일 형식

- **CSV** (`.csv`) - 간단하고 빠름
- **Excel** (`.xlsx`) - 서식 유지, 여러 시트 지원

---

## 2. 거래내역 내보내기 상세

### 2.1 내보내기 옵션

**범위 선택:**

- 전체 기간 (모든 거래내역)
- 선택한 기간 (시작일 ~ 종료일)
- 현재 필터된 데이터 (거래내역 페이지의 필터 적용)

**필터 옵션:**

- 타입: 전체 / 수입 / 지출
- 카테고리: 전체 / 특정 카테고리
- 결제수단: 전체 / 특정 결제수단

**형식 선택:**

- CSV
- Excel

### 2.2 내보내기 컬럼 구조

**기본 컬럼:**

- 날짜 (YYYY-MM-DD)
- 타입 (수입/지출)
- 금액
- 대분류
- 소분류
- 내역
- 메모
- 결제수단 (지출일 때만)
- 세부결제수단 (지출일 때만)
- 생성일시
- 수정일시

**컬럼명:**

- 한글 컬럼명 (기본)
- 영문 컬럼명 (옵션)

### 2.3 데이터 처리

1. **암호화된 데이터 복호화**
   - Store에서 이미 복호화된 데이터 사용
   - 또는 내보내기 시점에 복호화

2. **날짜 형식 변환**
   - Date 객체 → YYYY-MM-DD 문자열

3. **금액 포맷팅**
   - 숫자 → 문자열 (콤마 포함 옵션)

4. **정렬**
   - 날짜 내림차순 (최신순)

---

## 3. 자산 현황 내보내기 상세

### 3.1 내보내기 옵션

**범위 선택:**

- 현재 활성 자산만
- 전체 자산 (비활성 포함)
- 자산 변경 이력 포함 (옵션)

**형식 선택:**

- CSV
- Excel

### 3.2 내보내기 컬럼 구조

**자산 컬럼:**

- 이름
- 대분류
- 소분류
- 잔액
- 메모
- 상태 (활성/비활성)
- 생성일시
- 수정일시

**자산 로그 컬럼 (옵션):**

- 날짜
- 자산명
- 이전 잔액
- 변경 금액
- 새 잔액
- 설명
- 생성일시

---

## 4. UI/UX 설계

### 4.1 진입점

**거래내역 페이지:**

- "일괄 업로드" 버튼 옆에 "내보내기" 버튼 추가
- 또는 설정 메뉴에 "데이터 내보내기" 항목

**자산 페이지:**

- "자산 추가" 버튼 옆에 "내보내기" 버튼 추가

### 4.2 내보내기 모달/페이지

**PC: 모달**

- 내보내기 옵션 선택
  - 범위 선택 (전체 / 기간 선택 / 현재 필터)
  - 형식 선택 (CSV / Excel)
  - 컬럼명 선택 (한글 / 영문)
- 진행 상황 표시
- 다운로드 버튼

**모바일: 전체 페이지**

- 내보내기 옵션 선택 화면
- 진행 화면

### 4.3 옵션 선택 UI

**범위 선택:**

```
○ 전체 기간
○ 기간 선택
  [시작일] ~ [종료일]
○ 현재 필터된 데이터
  (거래내역 페이지에서만 표시)
```

**형식 선택:**

```
○ CSV
○ Excel
```

**컬럼명 선택:**

```
○ 한글 (기본)
○ 영문
```

---

## 5. 기술 구현

### 5.1 필요한 라이브러리

- `xlsx` (이미 설치됨) - Excel 파일 생성
- CSV는 직접 생성 (간단함)

### 5.2 파일 구조

```
src/
├── lib/
│   └── export/
│       ├── transactionExporter.ts    # 거래내역 내보내기
│       ├── assetExporter.ts          # 자산 내보내기
│       ├── csvGenerator.ts           # CSV 생성
│       └── excelGenerator.ts          # Excel 생성
├── components/
│   └── export/
│       ├── ExportTransactionModal.tsx  # 거래내역 내보내기 모달
│       ├── ExportTransactionPage.tsx  # 거래내역 내보내기 페이지 (모바일)
│       ├── ExportAssetModal.tsx       # 자산 내보내기 모달
│       └── ExportAssetPage.tsx        # 자산 내보내기 페이지 (모바일)
└── hooks/
    └── useExport.ts                   # 내보내기 로직 훅
```

### 5.3 CSV 생성

```typescript
function generateCSV(data: unknown[], headers: string[]): string {
  const rows = data.map((row) =>
    headers.map((header) => {
      const value = row[header]
      // CSV 이스케이프 처리
      if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
        return `"${value.replace(/"/g, '""')}"`
      }
      return value ?? ''
    })
  )

  return [headers.join(','), ...rows.map((row) => row.join(','))].join('\n')
}
```

### 5.4 Excel 생성

```typescript
import * as XLSX from 'xlsx'

function generateExcel(data: unknown[], headers: string[], sheetName: string): Blob {
  const ws = XLSX.utils.json_to_sheet(data, { header: headers })
  const wb = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(wb, ws, sheetName)

  return XLSX.write(wb, { type: 'blob', bookType: 'xlsx' })
}
```

### 5.5 파일 다운로드

```typescript
function downloadFile(blob: Blob, filename: string) {
  const url = URL.createObjectURL(blob)
  const link = document.createElement('a')
  link.href = url
  link.download = filename
  link.click()
  URL.revokeObjectURL(url)
}
```

---

## 6. 데이터 필터링

### 6.1 거래내역 필터링

**전체 기간:**

- Store의 모든 거래내역 사용
- 필요 시 여러 월 데이터 조회

**기간 선택:**

- 시작일 ~ 종료일 범위 필터링

**현재 필터:**

- 거래내역 페이지의 현재 필터 상태 사용
  - 타입 필터
  - 날짜 필터
  - 카테고리 필터 (추후)

### 6.2 자산 필터링

**활성 자산만:**

- `isActive === true` 필터링

**전체 자산:**

- 모든 자산 포함

---

## 7. 성능 고려사항

### 7.1 대용량 데이터 처리

- **청크 단위 처리**: 1000건씩 처리
- **진행 상황 표시**: 사용자에게 피드백 제공
- **메모리 관리**: Blob 생성 시 메모리 사용량 고려

### 7.2 제한사항

- **최대 행 수**: 10,000행 (선택)
- **파일 크기**: 브라우저 메모리 제한 고려

---

## 8. 보안 고려사항

1. **암호화된 데이터 복호화**
   - 내보내기 전에 복호화 완료 확인
   - 복호화 실패 시 에러 처리

2. **권한 체크**
   - Viewer도 내보내기 가능 (조회 권한)
   - 또는 Editor 이상만 가능 (선택)

3. **데이터 무결성**
   - 내보내기 전 데이터 검증
   - 빈 값 처리

---

## 9. 개발 단계

### Phase 1: 거래내역 내보내기 (우선)

1. ✅ CSV 생성 유틸리티
2. ✅ Excel 생성 유틸리티
3. ✅ 거래내역 필터링 로직
4. ✅ 거래내역 내보내기 로직
5. ✅ UI 컴포넌트 (모달/페이지)
6. ✅ 거래내역 페이지에 버튼 추가
7. ✅ 테스트

### Phase 2: 자산 내보내기

1. ⏳ 자산 필터링 로직
2. ⏳ 자산 내보내기 로직
3. ⏳ UI 컴포넌트
4. ⏳ 자산 페이지에 버튼 추가
5. ⏳ 테스트

### Phase 3: 개선

1. ⏳ 기간 선택 UI 개선
2. ⏳ 진행 상황 개선
3. ⏳ 파일명 자동 생성 (날짜 포함)
4. ⏳ 여러 시트 지원 (Excel)

---

## 10. 파일명 규칙

**거래내역:**

- CSV: `거래내역_2024-12-01_2024-12-31.csv`
- Excel: `거래내역_2024-12-01_2024-12-31.xlsx`

**자산:**

- CSV: `자산현황_2024-12-28.csv`
- Excel: `자산현황_2024-12-28.xlsx`

---

## 11. 사용자 시나리오

### 11.1 거래내역 내보내기

1. 거래내역 페이지 접속
2. "내보내기" 버튼 클릭
3. 옵션 선택:
   - 범위: "기간 선택"
   - 시작일: 2024-01-01
   - 종료일: 2024-12-31
   - 형식: Excel
   - 컬럼명: 한글
4. "내보내기" 버튼 클릭
5. 파일 다운로드

### 11.2 현재 필터된 데이터 내보내기

1. 거래내역 페이지에서 필터 설정:
   - 타입: 지출
   - 기간: 이번 달
2. "내보내기" 버튼 클릭
3. 옵션 선택:
   - 범위: "현재 필터된 데이터"
   - 형식: CSV
4. "내보내기" 버튼 클릭
5. 파일 다운로드

---

## 12. 확인 필요 사항

1. **범위 선택**: 전체 / 기간 선택 / 현재 필터 중 어떤 것을 기본값으로?
2. **형식 선택**: CSV / Excel 중 어떤 것을 기본값으로?
3. **컬럼명**: 한글 / 영문 중 어떤 것을 기본값으로?
4. **권한**: Viewer도 내보내기 가능한가?
5. **파일명**: 사용자가 직접 지정할 수 있는가?

---

## 마지막 업데이트

- 날짜: 2024-12-28
- 버전: 1.0.0
- 상태: 계획 완료
